import numpy as np
import copy
import statistics 
from demand_points import demand_point

#Our environment consist of the states of a all the demand points at a given point of time
# The class get_env is to create the environment by simulating/inputing data in different demand points and collecting them



class get_env:

# Intialising the class env 

  def __init__(self, demand_points_list, vehicles = None, time_horizon = None):
    self.demand_points =  [demand_point(x) for x in range(len(demand_points_list))]                                                                                                  # Placeholder to save the initial conditions of the environment
    self.vehicles = vehicles                                                                                             # No. of vehicles available for transfers 
    self.time_horizon = time_horizon                                                                                     # Time horizon for which transfers are being tracked
    self.day = 0                                                                                                         # Day of the time horizon
    self.inventory_transfers_tensor = np.zeros(shape = (time_horizon, len(demand_points_list), len(demand_points_list))) # tensor to track inventory transfers everyday
    self.vehicles_transfers_tensor = np.zeros(shape = (time_horizon, len(demand_points_list), len(demand_points_list)))  # tensor to track vehicles transfers everyday
    self.state = None                                                                                                    # An array for storing the states of the environment 
    self.demand_points_save = None                                                                                       # Placeholder to save the initial conditions of the environment
    self.day_save = None 
  
  def set(self,  initial_inv = None, initial_inv_mean = None , initial_inv_sd = None, initial_vehicles = None , hospitalisations = None, 
          lams = None, hospitalisation_trend = None, burn_rates = None , burn_rate_mean = None, burn_rate_sd = None, death_rate = None, mean_LOS_death = None, 
          mean_LOS_discharge = None, average_interarrival_time = None, uniform_start_index = None, uniform_interarrival_time = None, supply = None,\
          supply_amount = NotImplementedError) :
    for i in range(len(self.demand_points)):
      self.demand_points[i].intialise_new_horizon(self.time_horizon)
      self.demand_points[i].initial_inv(initial_inv[i])
      self.demand_points[i].initial_vehicles()
      self.demand_points[i].get_hospitalisations(lams = lams[i], hospitalisation_trend = hospitalisation_trend[i])
      self.demand_points[i].get_burn_rates(burn_rate_mean[i] , burn_rate_sd[i])
      #demand_points[i].get_discharge_deaths(4, 2, 20, 4)
      self.demand_points[i].get_discharge_deaths2(death_rate, mean_LOS_death, mean_LOS_discharge)
      self.demand_points[i].get_supply(supply_amount = supply_amount, average_interarrival_time = average_interarrival_time)
      self.demand_points_save = copy.deepcopy(self.demand_points)
      self.day_save  = copy.deepcopy(self.day) 

  def get_state(self):
      self.state = np.array([])
      for x in self.demand_points: 
        self.state = np.concatenate((self.state,x.get_state()))
      return self.state

  def reset(self):
     self.demand_points = self.demand_points_save
     self.day = 0
     self.get_state()
     return self.state

# Function for Calculating retreiving Action Matrix

  def get_inventory_transfers(self, action_selected):
    k = 0
    for i in range(len(self.demand_points)):
      for j in range(i + 1,len(self.demand_points)):
        self.inventory_transfers_tensor[self.day][i][j] = action_selected[k]
        self.inventory_transfers_tensor[self.day][j][i] = -action_selected[k]
        k = k + 1 

  def get_vehicles_transfers(self, actions_selected):
    k = int((1/2)*len(self.demand_points)*(len(self.demand_points) - 1) - 1)
    for i in range(len(self.demand_points)):
      for j in range(i + 1, len(self.demand_points)):
        self.vehicles_transfers_tensor[self.day][i][j] = actions_selected[k]
        self.vehicles_transfers_tensor[self.day][j][i] = -actions_selected[k]
        k = k + 1                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             

# Method for simulating the states/state variables when no action is taken 

  def actionlesss_simulation(self):
    self.state = np.empty((self.time_horizon,30))
    for j in range(self.time_horizon):
      state = np.array([])
      for i in range(len(self.demand_points)):
        a, b, c, done = self.demand_points[i].step()
        state = np.concatenate((state, c))
      self.state[j] = state
      self.day = self.day + 1   


  def step(self, actions_selected):
    done = False
    state = np.array([])
    reward_inputs = []
    feasible_transfers = []
    self.get_inventory_transfers(actions_selected)
    self.get_vehicles_transfers(actions_selected)
    vehicles_transfers_matrix = self.vehicles_transfers_tensor[self.day]
    inventory_transfers_matrix = self.inventory_transfers_tensor[self.day]
    for i in range(len(self.demand_points)):
      a, b, c, done = self.demand_points[i].step(vehicles_transfers_matrix, inventory_transfers_matrix) 
      state = np.concatenate((state, c)) 
      reward_inputs = reward_inputs + [b]
      feasible_transfers = feasible_transfers + [a]
    self.day = self.day + 1 
    reward = 0
    for x in reward_inputs:
      if x < 0 :  
        reward_inputs.remove(x)
        reward = reward + x
    if reward == 0:
      reward = statistics.harmonic_mean(reward_inputs)
    if sum(feasible_transfers) < len(feasible_transfers):
      reward = -100000
    if reward < 0 or self.day == self.inventory_transfers_tensor.shape[0] - 1:
      done = True
    return state, reward, done    

